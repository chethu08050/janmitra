<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat with Gemini - Enhanced Indian Languages</title>
  <script defer>
    const API_KEY = "AIzaSyAHcIvz7GCEb_lhY7mgRSPsSt3gD6hzg1M"; // Replace with your actual key
    let conversation = [];
    let synthesis = window.speechSynthesis;
    let recognition;
    let autoReadResponses = true; // Default to auto-read
    let continuousListening = false; // Control for continuous listening mode
    let listeningActive = false; // Track if we're currently listening
    
    // Language settings
    let currentLanguage = "hi-IN"; // Default to Hindi
    const languageOptions = {
      "hi-IN": { name: "Hindi", voiceURI: "Hindi" },
      "kn-IN": { name: "Kannada", voiceURI: "Kannada" },
      "en-IN": { name: "Indian English", voiceURI: "en-IN" }
    };

    // Initialize speech recognition if available
    function initSpeechRecognition() {
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = currentLanguage; // Use current language setting
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById("userInput").value = transcript;
          
          // If final result and in continuous mode, submit automatically
          if (event.results[0].isFinal && continuousListening) {
            sendMessage();
          }
        };
        
        recognition.onerror = (event) => {
          console.error("Speech recognition error", event.error);
          updateVoiceButtonState(false);
        };
        
        recognition.onend = () => {
          updateVoiceButtonState(false);
          
          // If in continuous mode, restart listening
          if (continuousListening && listeningActive) {
            setTimeout(() => {
              recognition.start();
              updateVoiceButtonState(true);
            }, 300);
          }
        };

        return true;
      } else {
        console.error("Speech recognition not supported in this browser");
        return false;
      }
    }

    function updateVoiceButtonState(isRecording) {
      const voiceButton = document.getElementById("voiceButton");
      if (isRecording) {
        voiceButton.classList.add("recording");
        voiceButton.innerHTML = "â¹ï¸";
        listeningActive = true;
      } else {
        voiceButton.classList.remove("recording");
        voiceButton.innerHTML = continuousListening ? "ðŸŽ¤ (Auto)" : "ðŸŽ¤";
        listeningActive = false;
      }
    }

    // Toggle speech recognition
    function toggleSpeechInput() {
      if (!recognition && !initSpeechRecognition()) {
        alert("Speech recognition is not supported in your browser.");
        return;
      }
      
      // Update recognition language
      recognition.lang = currentLanguage;
      
      // Toggle continuous mode with shift key press
      if (event && event.shiftKey) {
        continuousListening = !continuousListening;
        document.getElementById("voiceButton").innerHTML = continuousListening ? "ðŸŽ¤ (Auto)" : "ðŸŽ¤";
        
        // If turning on continuous and not already listening, start it
        if (continuousListening && !listeningActive) {
          recognition.start();
          updateVoiceButtonState(true);
        }
        return;
      }
      
      // Regular toggle behavior
      if (listeningActive) {
        recognition.stop();
        updateVoiceButtonState(false);
      } else {
        recognition.start();
        updateVoiceButtonState(true);
      }
    }

    // Text to speech function with improved pronunciation
    function speakText(text) {
      if (synthesis.speaking) {
        synthesis.cancel();
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = currentLanguage;
      
      // Apply improved voice settings
      applyOptimalVoiceSettings(utterance);
      
      synthesis.speak(utterance);
      
      // Toggle speak button appearance
      const speakButtons = document.querySelectorAll('.speak-button');
      speakButtons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = "ðŸ”Š";
      });
      
      // Update voice indicator
      document.getElementById("voiceStatus").classList.add("speaking");
      
      utterance.onend = function() {
        speakButtons.forEach(btn => {
          btn.disabled = false;
          btn.innerHTML = "ðŸ”Š";
        });
        document.getElementById("voiceStatus").classList.remove("speaking");
        
        // If in continuous mode, start listening again after speaking finishes
        if (continuousListening && !listeningActive) {
          setTimeout(() => {
            recognition.start();
            updateVoiceButtonState(true);
          }, 500);
        }
      };
    }
    
    // Apply optimized voice settings for Indian languages
    function applyOptimalVoiceSettings(utterance) {
      // Get available voices
      const voices = synthesis.getVoices();
      console.log("Available voices:", voices.map(v => `${v.name} (${v.lang})`).join(", "));
      
      // Find the best voice for the current language
      let selectedVoice = null;
      
      // Try to find an exact match first
      selectedVoice = voices.find(voice => 
        voice.lang === currentLanguage || 
        voice.name.includes(languageOptions[currentLanguage].name)
      );
      
      // If no exact match, try to find any Indian voice
      if (!selectedVoice) {
        selectedVoice = voices.find(voice => 
          voice.lang.includes('IN') || 
          voice.name.includes('Indian')
        );
      }
      
      // If still no match, try to find any voice that might work
      if (!selectedVoice && currentLanguage === "hi-IN") {
        selectedVoice = voices.find(voice => 
          voice.lang.includes('hi') || 
          voice.name.includes('Hindi')
        );
      } else if (!selectedVoice && currentLanguage === "kn-IN") {
        selectedVoice = voices.find(voice => 
          voice.lang.includes('kn') || 
          voice.name.includes('Kannada')
        );
      }
      
      // If we found a voice, use it
      if (selectedVoice) {
        console.log(`Using voice: ${selectedVoice.name} (${selectedVoice.lang})`);
        utterance.voice = selectedVoice;
      } else {
        console.log("No suitable voice found, using default");
      }
      
      // Optimize settings for clarity
      utterance.rate = 0.9;  // Slightly slower for better clarity
      utterance.pitch = 1.0; // Normal pitch
      utterance.volume = 1.0; // Full volume
    }

    // Change language
    function changeLanguage(lang) {
      currentLanguage = lang;
      
      // Update UI
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Update recognition language if initialized
      if (recognition) {
        recognition.lang = lang;
      }
      
      // Log change
      console.log(`Language changed to: ${languageOptions[lang].name}`);
    }

    // Toggle auto-read responses
    function toggleAutoRead() {
      autoReadResponses = !autoReadResponses;
      const autoReadBtn = document.getElementById("autoReadButton");
      autoReadBtn.innerHTML = autoReadResponses ? "ðŸ”Š Auto" : "ðŸ”Š Manual";
      autoReadBtn.classList.toggle("active", autoReadResponses);
    }

    // Stop speaking
    function stopSpeaking() {
      if (synthesis.speaking) {
        synthesis.cancel();
        document.getElementById("voiceStatus").classList.remove("speaking");
      }
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      // Stop any ongoing speech when sending a new message
      stopSpeaking();

      // If in voice recognition mode, stop listening
      if (listeningActive) {
        recognition.stop();
        updateVoiceButtonState(false);
      }

      conversation.push({ role: "user", text });
      renderChat();
      input.value = "";

      // Show typing indicator
      const typingIndicator = document.createElement("div");
      typingIndicator.className = "p-3 my-2 rounded-xl max-w-[80%] bg-gray-200 text-black self-start typing-indicator";
      typingIndicator.innerHTML = '<div class="typing-dots"><span>.</span><span>.</span><span>.</span></div>';
      document.getElementById("chatBox").appendChild(typingIndicator);

      // Define language-specific instructions based on currentLanguage
      let languageInstruction = "";
      if (currentLanguage === "hi-IN") {
        languageInstruction = "Please respond in Hindi only. Keep answers short and direct. ";
      } else if (currentLanguage === "kn-IN") {
        languageInstruction = "Please respond in Kannada only. Keep answers short and direct. ";
      }

      // Ask Gemini with language instructions
                  const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [
              {
                parts: [{
                  text: `${languageInstruction}Give brief, direct answers (1-2 sentences). If you don't know, provide a short logical response. Don't translate. if u dont knoe the exact answer then predict the answer and tell randomly and it should make sence but dont give uncertain answers : "${text}"`
                }]
              }
            ]
          })
        }
      );

      try {
        const data = await response.json();
        const botReply = data.candidates[0].content.parts[0].text;
        
        // Remove typing indicator
        document.getElementById("chatBox").removeChild(typingIndicator);
        
        conversation.push({ role: "gemini", text: botReply });
        renderChat();
        
        // Auto-read the response if enabled
        if (autoReadResponses) {
          speakText(botReply);
        }
      } catch (err) {
        // Remove typing indicator
        document.getElementById("chatBox").removeChild(typingIndicator);
        
        const errorMsg = "Error: Unable to get response.";
        conversation.push({ role: "gemini", text: errorMsg });
        renderChat();
        
        if (autoReadResponses) {
          speakText(errorMsg);
        }
      }
    }

    function renderChat() {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      conversation.forEach((msg, index) => {
        const bubble = document.createElement("div");
        bubble.className = `p-3 my-2 rounded-xl max-w-[80%] ${
          msg.role === "user"
            ? "bg-blue-500 text-white self-end"
            : "bg-gray-200 text-black self-start flex items-start"
        }`;
        
        if (msg.role === "gemini") {
          const messageText = document.createElement("span");
          messageText.innerText = msg.text;
          bubble.appendChild(messageText);
          
          const speakButton = document.createElement("button");
          speakButton.className = "speak-button ml-2 text-sm bg-blue-100 hover:bg-blue-200 rounded-full w-6 h-6 flex items-center justify-center";
          speakButton.innerHTML = "ðŸ”Š";
          speakButton.onclick = () => speakText(msg.text);
          bubble.appendChild(speakButton);
        } else {
          bubble.innerText = msg.text;
        }
        
        chatBox.appendChild(bubble);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Initialize voices on page load
    function initVoices() {
      // Force voice list update for Safari
      speechSynthesis.getVoices();
      
      // Log available voices to console
      setTimeout(() => {
        const voices = speechSynthesis.getVoices();
        console.log(`Loaded ${voices.length} voices:`);
        voices.forEach(voice => {
          console.log(`- ${voice.name} (${voice.lang}): ${voice.localService ? 'local' : 'remote'}`);
        });
      }, 100);
    }
  </script>
  <style>
    .recording {
      background-color: #ef4444 !important;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    .active {
      background-color: #3b82f6 !important;
      color: white;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
    }
    
    .typing-dots {
      display: flex;
    }
    
    .typing-dots span {
      animation: bounce 1s infinite;
      margin-right: 2px;
      font-size: 20px;
      line-height: 10px;
    }
    
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .voice-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #d1d5db;
      transition: all 0.3s ease;
    }
    
    .voice-status.speaking {
      background-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      animation: pulse 1.5s infinite;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .lang-selector {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .lang-btn {
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .lang-btn:hover {
      background-color: #e2e8f0;
    }
    
    .lang-btn.active {
      background-color: #3b82f6;
      color: white;
      border-color: #2563eb;
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-2xl bg-white shadow-lg rounded-2xl flex flex-col h-[90vh]">
    <div class="p-4 border-b text-lg font-semibold text-blue-600 flex justify-between items-center">
      <div class="flex items-center">
        <span>ðŸ’¬ Chat with Gemini</span>
        <div id="voiceStatus" class="voice-status ml-2"></div>
      </div>
      <div class="flex space-x-2">
        <button id="autoReadButton" onclick="toggleAutoRead()" class="tooltip bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-md active">
          ðŸ”Š Auto
          <span class="tooltiptext">Toggle auto-read responses</span>
        </button>
        <button id="stopSpeakingButton" onclick="stopSpeaking()" class="tooltip bg-gray-200 hover:bg-gray-300 p-2 rounded-full">
          ðŸ”‡
          <span class="tooltiptext">Stop speaking</span>
        </button>
      </div>
    </div>

    <!-- Language selector -->
    <div class="px-4 pt-3 pb-1 border-b">
      <div class="lang-selector">
        <button class="lang-btn" data-lang="en-IN" onclick="changeLanguage('en-IN')">English</button>
        <button class="lang-btn active" data-lang="hi-IN" onclick="changeLanguage('hi-IN')">Hindi</button>
        <button class="lang-btn" data-lang="kn-IN" onclick="changeLanguage('kn-IN')">Kannada</button>
      </div>
    </div>

    <div id="chatBox" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-2 bg-gray-50"></div>

    <div class="p-4 border-t flex space-x-2">
      <input id="userInput" type="text" placeholder="Type your message..."
             class="flex-1 p-2 border rounded-md" onkeydown="if(event.key==='Enter') sendMessage()" />
      <button id="voiceButton" onclick="toggleSpeechInput()" 
              class="tooltip bg-gray-200 hover:bg-gray-300 p-2 rounded-full">
        ðŸŽ¤
        <span class="tooltiptext">Click to speak (Shift+Click for continuous mode)</span>
      </button>
      <button onclick="sendMessage()"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Send</button>
    </div>
  </div>
  
  <script>
    // Initialize voices when they become available
    window.speechSynthesis.onvoiceschanged = function() {
      const voices = window.speechSynthesis.getVoices();
      console.log("Voices loaded:", voices.length);
      
      // Log available voices to help debugging
      voices.forEach(voice => {
        console.log(`Voice: ${voice.name}, Lang: ${voice.lang}, Local: ${voice.localService}`);
      });
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize speech voices
      initVoices();
      
      // Initialize speech recognition if browser supports it
      initSpeechRecognition();
      
      // Load initial greeting based on language
      let greeting = "Hello! I'm Gemini. How can I help?";
      if (currentLanguage === "hi-IN") {
        greeting = "Namaste! Main Gemini hoon. Kaise madad kar sakta hoon?";
      } else if (currentLanguage === "kn-IN") {
        greeting = "Namaskara! Naanu Gemini. Nimage hege sahaya maadabahadu?";
      }
      
      conversation.push({ role: "gemini", text: greeting });
      renderChat();
      
      // Auto-speak the greeting
      if (autoReadResponses) {
        setTimeout(() => {
          speakText(greeting);
        }, 500);
      }
    });
  </script>
</body>
</html>